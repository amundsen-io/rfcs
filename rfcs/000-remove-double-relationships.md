- Feature Name: Remove double relationships between Neo4j nodes
- Start Date: 2021-05-25
- RFC PR: [amundsen-io/rfcs#0000](https://github.com/amundsen-io/rfcs/pull/0000)
- Amundsen Issue: 

# Remove double relationships between Neo4j nodes

## Summary

Currently all (most?) relationships between Neo4j nodes are modeled with
two directional edges. This RFC proposes we only use one directional edge
between the nodes.

## Motivation

The double relationship graph model makes Neo4j queries more complicated
than they need to be, with no performance or functional benefit. Additionally
due to conflicting changes in the past ([PR 70](https://github.com/amundsen-io/amundsenmetadatalibrary/pull/70)
and [PR 206](https://github.com/amundsen-io/amundsenmetadatalibrary/pull/206)),
Amundsen instances that have been running and ingesting data since prior to
PR 70 or PR 206 have inconsistent Neo4j database state. Some nodes have a
single relationship between then, some have two.

There are two relevant Slack discussions regarding this change:

https://app.slack.com/client/TGFR0CZM3/CGFBVT23V/thread/CGFBVT23V-1615391140.022900
- a thread where I asked the question on why the double relationships exist

https://app.slack.com/client/TGFR0CZM3/CGFBVT23V/thread/CGFBVT23V-1563487877.254000
- a thread with Joshua Haskins' benchmarking results for modeling the relationships
  with one or two edges

### Context

[PR 70](https://github.com/amundsen-io/amundsenmetadatalibrary/pull/70) removed
the _OF type relationships merged in September 5, 2019. So the change suggested
in this RFC was already done once. Unfortunately, however, the corresponding
change was never done on the databuilder side of things, so databuilder was still
creating double relationships while actions triggered in the UI were creating or
deleting only single relationships.

This discrepancy was then addressed in [PR 206](https://github.com/amundsen-io/amundsenmetadatalibrary/pull/206)
merged in October 5, 2020 by putting the creation of double relationships back in
the code, effectively reversing the changes in PR 70. What should have happened
instead is the removal of creating double relationships in the databuilder.

Furthermore PR 206 didn't implement any database migration scripts to fix the
issues with the inconsistent Neo4j database state.


### Potential Performance Impact of Double Relationships

While it's probably true no (current) Amundsen deployment reaches a size
where the double relationships would create any meaningful performance issues,
Neo4j scales inversely to number of nodes/edges and the properties in them.
The larger your graph is, the slower operating on it will be. Currently
Amundsen is creating double the amount of relationships required. The relationships
don't contain any properties, so the impact will be quite small.

The match statements implemented in in [neo4j_proxy.py](https://github.com/amundsen-io/amundsen/blob/main/metadata/metadata_service/proxy/neo4j_proxy.py#L1159)
illustrate a problem for read performance and correctness, however.

The MATCH statement created looks like this:

```
(t:Table ...)-[r1:OWNER]->(u:User ...)-[r2:OWNER_OF]->(t:Table ...)
```

There are two problems with this.

First, it's doing more work. It is following two relationships. That will
always be slower than following just one. Obviously on small graphs, it's
not going to create much of an impact.

Second, potentially more worrying issue, is that due to the issue created
in PR 70, Amundsen instances installed prior to PR 206 will return the
wrong results for queries generated by this code, depending on the state
of the database. If the OWNER_OF relationship is missing between some
tables and users due to it having been removed from the codebase in PR 70,
this query will not return all relevant results.


## Transition Path

The implementation work involved:

For each double relationship pair, we need to decide which relationship type
to keep and which one to remove. I suggest we do this by keeping the directionality
and tag name consistent (e.g. remove all relationships with _BY or _OF suffix).
There might be instances where we need to change the direction of the relationship,
because FOO_BY and BAR_BY relationships might've been defined using the opposite
directionality.

Delete the insertion, deletion and querying of the relationship type we've decided
to remove from the code, and, if needed, change the direction of the relationships
we've decided to keep.

Create a database migration script that deletes the relationship types we've
decided to remove from the Neo4j database, and change the direction of any
relationship we've decided to keep, if needed. Additionally the database migration
script should correct the inconsistent data issues created in PR 70.

There is no transition path for new installations. They will simply start using
the single relationships graph model from the get go.

For existing Amundsen instances we'll need to make sure the database migration
script is run after upgrading Amundsen to a version where the double relationships
have been removed.

## How We Communicate This

TBD

## Drawbacks

I think the biggest reason for not doing this is the potential for the database state
to become even more inconsistent for Amundsen instances that have been running since
before PR 70 or PR 206. We'll need to make sure that the db migration scripts either
run automatically, running the db migrations is made abundantly clear and not optional
to any Amundsen users, or there's some sort of clear notification provided in Amundsen
UI if the db migration scripts haven't been run.

It is possible dataset ownership information, as an example, and other information linked
with a double relationship could become inaccessible, if the database state isn't migrated
properly.


## Alternatives

The alternative of not doing the change will leave existing Amundsen instances' Neo4j
databases in an inconsistent state, unless they were stood up after PR 206. The other
reason in favor of implementing the change rather than not, is that using single
relationships is actually the right way to model Neo4j graphs. There isn't a single
Neo4j tutorial or data modeling guide that advocates for double relationships. It's
just maintenance overhead and complicates the creation of nodes/edges, as well as
querying the Neo4j data.

## Unresolved questions

The exact implementation of Neo4j database migration scripts and how they get executed
is something that requires a bit more Amundsen expertise that I currently have. Same
goes for the communications plan.

Additionally the list of double relationship pairs need to be compiled and a decision
made on which relationship from each pair to remove, and should we change the direction
of the remaining relationship. I can compile the list and make a first pass proposal
on which relationships to delete and any direction changes once we get consensus on
whether this change is warranted or not.

## Future possibilities

It fixes a source of database inconsistencies, makes the Neo4j database model
consistent with Neo4j database modeling best practices and simplifies the database
operations implementations for Neo4j within Amundsen. All of those benefits should
make future changes in the Neo4j database model easier to implement.